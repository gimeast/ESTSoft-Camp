<!doctype html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Title</title>
        <style>
            .filter.active {
                background-color: lightcoral;
            }
        </style>
    </head>
    <body>
        <h1>Redux Airbnb 필터링</h1>
        <main>
            <section>
                <h2>편의시설 필터:</h2>
                <ul class="filterList"></ul>
            </section>
            <section>
                <h2>활성 필터: TV | 결과: <span class="count"></span>개</h2>
                <ul class="lodgingList"></ul>
            </section>
        </main>
    </body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.2.0/redux.js"></script>
    <script>
        const filterList = [
            "무료 주차 공간",
            "대형 욕조",
            "바베큐 그릴",
            "게스트용 별채",
            "수영장",
            "주방",
            "TV",
        ];

        const lodgingList = [
            {
                title: "도심 아파트 - 강남구",
                price: 85000,
                amenities: ["무료 주차 공간", "주방", "TV"],
            },
            {
                title: "럭셔리 펜트하우스 - 한남동",
                price: 250000,
                amenities: [
                    "대형 욕조",
                    "수영장",
                    "게스트용 별채",
                    "주방",
                    "TV",
                ],
            },
            {
                title: "산속 별장 - 평창",
                price: 95000,
                amenities: [
                    "바베큐 그릴",
                    "게스트용 별채",
                    "무료 주차 공간",
                    "TV",
                ],
            },
        ];

        const $lodgingList = document.querySelector(".lodgingList");

        const initialState = {
            filteredList: [],
            originLodgingList: lodgingList,
            filteredLodgingList: lodgingList,
        };

        const reducer = (state = initialState, action) => {
            switch (action.type) {
                case "FILTER":
                    let filteredList = [];

                    if (state.filteredList.includes(action.filter)) {
                        filteredList = state.filteredList.filter(
                            (filter) => filter !== action.filter
                        );
                    } else {
                        filteredList = [...state.filteredList, action.filter];
                    }

                    let filteredLodgingList = [];
                    if (filteredList.length === 0) {
                        filteredLodgingList = state.originLodgingList;
                    } else {
                        filteredLodgingList = state.originLodgingList.filter(
                            (originLodging) =>
                                filteredList.every((filter) =>
                                    originLodging.amenities.includes(filter)
                                )
                        );
                    }

                    return { ...state, filteredList, filteredLodgingList };
                default:
                    return state;
            }
        };

        const store = Redux.createStore(
            reducer,
            window.__REDUX_DEVTOOLS_EXTENSION__ &&
                window.__REDUX_DEVTOOLS_EXTENSION__()
        );

        store.subscribe(component);

        function filterActionCreator(filter) {
            return { type: "FILTER", filter };
        }

        function handleFilterAction(filter) {
            const action = filterActionCreator(filter);
            store.dispatch(action);
        }

        function component() {
            const $filters = document.querySelectorAll(".filter");
            const { filteredList, filteredLodgingList } = store.getState();

            $filters.forEach((filter) => {
                const isActive = filteredList.includes(filter.textContent);
                filter.classList.toggle("active", isActive);
            });

            lodgingListRender(filteredLodgingList);
        }

        function lodgingListRender(filteredLodgingList) {
            $lodgingList.innerHTML = filteredLodgingList
                .map((filteredLodging) => {
                    return `
                        <li>
                        <h3>${filteredLodging.title}</h3>
                        <span>${filteredLodging.price}</span>
                        <ul>
                        ${filteredLodging.amenities
                            .map((amenity) => {
                                return `<li>${amenity}</li>`;
                            })
                            .join("")}
                        </ul>
                        </li>
                        `;
                })
                .join("");
        }

        function initRender() {
            const $filterList = document.querySelector(".filterList");
            const fragment = document.createDocumentFragment();
            const { filteredLodgingList } = store.getState();

            filterList.forEach((filter) => {
                const li = document.createElement("li");
                const button = document.createElement("button");
                button.className = "filter";
                button.textContent = filter;
                button.onclick = () => handleFilterAction(filter);

                li.appendChild(button);
                fragment.appendChild(li);
            });

            $filterList.appendChild(fragment);

            lodgingListRender(filteredLodgingList);
        }

        initRender();
    </script>
</html>
